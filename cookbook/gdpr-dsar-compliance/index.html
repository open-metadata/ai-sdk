<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GDPR DSAR Compliance - Metadata AI</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f8f9fb;
      color: #1a1a2e;
      line-height: 1.6;
    }

    .container {
      max-width: 860px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    header {
      margin-bottom: 2rem;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1a1a2e;
    }

    header p {
      color: #555;
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }

    .card {
      background: #fff;
      border: 1px solid #e2e4e9;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.25rem;
    }

    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: #444;
      margin-bottom: 0.3rem;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
      transition: border-color 0.15s;
    }

    textarea:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
    }

    .hint {
      font-size: 0.8rem;
      color: #888;
      margin-top: 0.3rem;
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.25rem;
      background: #7c3aed;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s;
      margin-top: 1rem;
    }

    button:hover:not(:disabled) { background: #6d28d9; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ── Activity feed ─────────────────────────────────────── */
    #activity {
      display: none;
      border: 1px solid #e0d7fa;
      border-radius: 6px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: #444;
    }

    #activity.visible { display: block; }

    #activity summary {
      list-style: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: #f5f3ff;
      border-radius: 6px;
      cursor: pointer;
      color: #5b21b6;
      font-weight: 500;
    }

    #activity summary::-webkit-details-marker { display: none; }

    #activity[open] summary {
      border-radius: 6px 6px 0 0;
    }

    #activity-log {
      max-height: 240px;
      overflow-y: auto;
      padding: 0.5rem 1rem;
    }

    .activity-narration {
      margin: 0.2rem 0;
      color: #555;
      font-style: italic;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .activity-turn {
      margin: 0.4rem 0;
      color: #7c3aed;
      font-weight: 500;
      font-size: 0.8rem;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid #c4b5fd;
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      flex-shrink: 0;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Response area ─────────────────────────────────────── */
    #response {
      display: none;
    }

    #response.visible { display: block; }

    #response-content {
      line-height: 1.7;
      font-size: 0.95rem;
    }

    #response-content h1, #response-content h2, #response-content h3 {
      margin-top: 1.25rem;
      margin-bottom: 0.5rem;
    }

    #response-content h1 { font-size: 1.3rem; }
    #response-content h2 { font-size: 1.15rem; }
    #response-content h3 { font-size: 1.05rem; }

    #response-content p { margin-bottom: 0.75rem; }

    #response-content ul, #response-content ol {
      margin-bottom: 0.75rem;
      padding-left: 1.5rem;
    }

    #response-content li { margin-bottom: 0.3rem; }

    #response-content table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    #response-content th, #response-content td {
      border: 1px solid #e2e4e9;
      padding: 0.5rem 0.75rem;
      text-align: left;
    }

    #response-content th {
      background: #f8f9fb;
      font-weight: 600;
    }

    #response-content code {
      background: #f3f4f6;
      padding: 0.15rem 0.35rem;
      border-radius: 3px;
      font-size: 0.88em;
    }

    #response-content pre {
      background: #1e1e2e;
      color: #cdd6f4;
      padding: 1rem;
      border-radius: 6px;
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    #response-content pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    #response-content blockquote {
      border-left: 3px solid #7c3aed;
      padding-left: 1rem;
      color: #555;
      margin-bottom: 0.75rem;
    }

    .error-msg {
      color: #dc2626;
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>GDPR DSAR Compliance</h1>
      <p>Submit a Data Subject Access Request to trace customer data, discover related tables via lineage, and check retention policies.</p>
    </header>

    <!-- DSAR Input -->
    <div class="card">
      <h2>Data Subject Request</h2>
      <label for="dsar-input">Describe the DSAR</label>
      <textarea id="dsar-input" placeholder="Example: Customer Michael Perez (customer_id: 1, email: mperez@example.com) has requested deletion of all his personal data under GDPR Article 17. Search for tables where his data resides, trace lineage to find all related tables, identify PII columns in each, and check retention policies for conflicts with immediate deletion."></textarea>
      <p class="hint">Include the customer's identifiers (name, email, customer ID) and the request type (deletion, access, rectification). The agent will search for relevant tables, trace lineage, and check retention policies.</p>
      <button id="submit-btn">Submit Request</button>
    </div>

    <!-- Response -->
    <div id="response" class="card">
      <h2>Compliance Report</h2>

      <details id="activity" open>
        <summary id="activity-summary">
          <div class="spinner"></div>
          <span>Agent is analyzing...</span>
        </summary>
        <div id="activity-log"></div>
      </details>

      <div id="response-content"></div>
    </div>

  </div>

  <script>
    var responseCard    = document.getElementById("response");
    var activity        = document.getElementById("activity");
    var activitySummary = document.getElementById("activity-summary");
    var activityLog     = document.getElementById("activity-log");
    var responseContent = document.getElementById("response-content");
    var submitBtn       = document.getElementById("submit-btn");
    var dsarInput       = document.getElementById("dsar-input");

    function showError(msg) {
      responseCard.classList.add("visible");
      activity.classList.remove("visible");
      responseContent.innerHTML = '<div class="error-msg">' + msg + '</div>';
      submitBtn.disabled = false;
    }

    async function submitDSAR() {
      var message = dsarInput.value.trim();
      if (!message) return;

      // Reset UI
      activityLog.innerHTML = "";
      responseContent.innerHTML = "";
      responseCard.classList.add("visible");
      activity.classList.add("visible");
      activity.open = true;
      activitySummary.innerHTML =
        '<div class="spinner"></div><span>Agent is analyzing...</span>';
      submitBtn.disabled = true;

      // Tracks the live narration element being streamed into
      var liveEl = null;
      var currentText = "";

      function flushNarration() {
        if (liveEl && currentText.trim()) {
          liveEl.classList.remove("live");
          activityLog.appendChild(document.createElement("br"));
        }
        liveEl = null;
        currentText = "";
      }

      function appendContent(text) {
        currentText += text;
        if (!liveEl) {
          liveEl = document.createElement("p");
          liveEl.className = "activity-narration";
          activityLog.appendChild(liveEl);
        }
        liveEl.textContent = currentText.replace(/([.!?])(?=[A-Z])/g, "$1\n");
        activityLog.scrollTop = activityLog.scrollHeight;
      }

      try {
        var res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: message }),
        });

        if (!res.ok) {
          var errData = await res.json();
          throw new Error(errData.error || "API error (" + res.status + ")");
        }

        if (!res.body) throw new Error("Streaming not supported — try Chrome, Firefox, or Safari 14.1+");
        var reader = res.body.getReader();
        var decoder = new TextDecoder();
        var buffer = "";
        var report = "";

        while (true) {
          var chunk = await reader.read();
          if (!chunk.done) {
            buffer += decoder.decode(chunk.value, { stream: true });
          } else {
            buffer += decoder.decode(); // flush remaining bytes
          }

          var idx;
          while ((idx = buffer.indexOf("\n\n")) !== -1) {
            var raw = buffer.slice(0, idx).trim();
            buffer = buffer.slice(idx + 2);
            if (!raw.startsWith("data: ")) continue;

            var event;
            try { event = JSON.parse(raw.slice(6)); } catch (_) { continue; }

            switch (event.type) {
              case "content":
                appendContent(event.text);
                break;

              case "tool":
                flushNarration();
                break;

              case "turn":
                flushNarration();
                var turnEl = document.createElement("p");
                turnEl.className = "activity-turn";
                turnEl.textContent = "Continuing analysis (turn " + event.number + ")...";
                activityLog.appendChild(turnEl);
                break;

              case "done":
                report = event.report || "";
                break;

              case "error":
                throw new Error(event.message);
            }
          }

          if (chunk.done) break;
        }

        // Remove the live streaming element from the activity log so the
        // thinking steps keep their original formatting.
        if (liveEl) liveEl.remove();

        if (report) {
          responseContent.innerHTML = marked.parse(report);
        } else {
          responseContent.textContent = "Agent returned an empty response.";
        }

        // Collapse activity feed — user can re-open it
        activity.open = false;
        activitySummary.innerHTML = "<span>Agent activity</span>";

      } catch (err) {
        showError(err.message);
      } finally {
        submitBtn.disabled = false;
      }
    }

    submitBtn.addEventListener("click", submitDSAR);

    dsarInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        submitDSAR();
      }
    });
  </script>
</body>
</html>
