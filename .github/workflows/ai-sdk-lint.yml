name: Linting & Styling

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ai-sdk-lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      cli: ${{ steps.filter.outputs.cli }}
      typescript: ${{ steps.filter.outputs.typescript }}
      java: ${{ steps.filter.outputs.java }}
      python: ${{ steps.filter.outputs.python }}
      n8n: ${{ steps.filter.outputs.n8n }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Filter paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cli:
              - 'cli/**'
            typescript:
              - 'typescript/**'
            java:
              - 'java/**'
            python:
              - 'python/**'
            n8n:
              - 'n8n-nodes-metadata/**'

  rust-lint:
    name: Rust CLI Lint
    needs: changes
    if: needs.changes.outputs.cli == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cli

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cli/target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('cli/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lint-

      - name: Check formatting
        run: cargo fmt --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

  typescript-lint:
    name: TypeScript SDK Lint
    needs: changes
    if: needs.changes.outputs.typescript == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: typescript

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: typescript/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

  python-lint:
    name: Python SDK Lint
    needs: changes
    if: needs.changes.outputs.python == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: python/pyproject.toml

      - name: Install dependencies
        run: pip install -e ".[dev]"

      - name: Run linting
        run: ruff check src tests

      - name: Run formatting check
        run: ruff format --check src tests

  java-lint:
    name: Java SDK Lint
    needs: changes
    if: needs.changes.outputs.java == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: java

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check code formatting with Spotless
        run: mvn spotless:check -q

  n8n-lint:
    name: n8n Node Lint
    needs: changes
    if: needs.changes.outputs.n8n == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: n8n-nodes-metadata/package.json

      # Build TypeScript SDK first (n8n depends on it via file:../typescript)
      - name: Install TypeScript SDK dependencies
        working-directory: typescript
        run: npm ci

      - name: Build TypeScript SDK
        working-directory: typescript
        run: npm run build

      - name: Install dependencies
        working-directory: n8n-nodes-metadata
        run: npm install

      - name: Run linting
        working-directory: n8n-nodes-metadata
        run: npm run lint

  lint-success:
    name: Lint Success
    needs: [changes, rust-lint, typescript-lint, python-lint, java-lint, n8n-lint]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check all lint jobs
        run: |
          RUST_RESULT="${{ needs.rust-lint.result }}"
          TS_RESULT="${{ needs.typescript-lint.result }}"
          PYTHON_RESULT="${{ needs.python-lint.result }}"
          JAVA_RESULT="${{ needs.java-lint.result }}"
          N8N_RESULT="${{ needs.n8n-lint.result }}"

          for result in "$RUST_RESULT" "$TS_RESULT" "$PYTHON_RESULT" "$JAVA_RESULT" "$N8N_RESULT"; do
            if [ "$result" = "failure" ]; then
              echo "One or more lint jobs failed"
              exit 1
            fi
          done

          echo "All lint jobs passed or were skipped"
