name: Release

# Triggered when a GitHub Release is published with a v* tag (e.g., v0.2.0).
# Validates version consistency, then publishes all SDKs in parallel:
#   - Python SDK → PyPI
#   - TypeScript SDK → npm
#   - Java SDK → Maven Central
#   - CLI binaries → attached to the GitHub Release
#
# For individual SDK releases, push SDK-specific tags instead:
#   python-v0.2.0, typescript-v0.2.0, java-v0.2.0, cli-v0.2.0

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
        description: 'Version to release (e.g., 0.2.0)'

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-${{ github.event.release.tag_name || inputs.version }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Release
    # Only run for unified version tags (v*) on release events, always run on workflow_dispatch
    if: github.event_name == 'workflow_dispatch' || startsWith(github.event.release.tag_name, 'v')
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            TAG="${{ github.event.release.tag_name }}"
            VERSION="${TAG#v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Validate VERSION file matches release tag
        run: |
          VERSION=${{ steps.version.outputs.version }}
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
          # Compare only first 3 components (major.minor.patch), allowing tag suffixes like 0.0.2.1
          TAG_BASE=$(echo "$VERSION" | cut -d. -f1-3)
          FILE_BASE=$(echo "$FILE_VERSION" | cut -d. -f1-3)
          if [ "$FILE_BASE" != "$TAG_BASE" ]; then
            echo "::error::VERSION file ($FILE_VERSION) does not match release tag ($VERSION) - comparing first 3 components"
            echo "Run 'make bump-version V=$TAG_BASE' and push before creating the release."
            exit 1
          fi

      - name: Validate all SDK versions match
        run: make check-versions

  release-python:
    name: Python SDK
    needs: validate
    uses: ./.github/workflows/ai-sdk-release-python.yml
    with:
      version: ${{ needs.validate.outputs.version }}
    secrets: inherit

  release-typescript:
    name: TypeScript SDK
    needs: validate
    uses: ./.github/workflows/ai-sdk-release-typescript.yml
    with:
      version: ${{ needs.validate.outputs.version }}
    secrets: inherit

  release-java:
    name: Java SDK
    needs: validate
    uses: ./.github/workflows/ai-sdk-release-java.yml
    with:
      version: ${{ needs.validate.outputs.version }}
    secrets: inherit

  release-cli:
    name: CLI Binaries
    needs: validate
    uses: ./.github/workflows/ai-sdk-release-cli.yml
    with:
      version: ${{ needs.validate.outputs.version }}
      release_tag: ${{ github.event.release.tag_name || '' }}
    secrets: inherit
