#!/bin/bash
# Pre-commit hook for metadata-ai-sdk
# Runs formatting via Makefile recipes for staged files in each SDK

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No staged files to check.${NC}"
    exit 0
fi

# Track which SDKs have changes
PYTHON_CHANGED=false
RUST_CHANGED=false
TYPESCRIPT_CHANGED=false
JAVA_CHANGED=false
N8N_CHANGED=false

for file in $STAGED_FILES; do
    case "$file" in
        python/*) PYTHON_CHANGED=true ;;
        cli/*) RUST_CHANGED=true ;;
        typescript/*) TYPESCRIPT_CHANGED=true ;;
        java/*) JAVA_CHANGED=true ;;
        n8n-nodes-metadata/*) N8N_CHANGED=true ;;
    esac
done

FAILED=false

# Python SDK
if [ "$PYTHON_CHANGED" = true ]; then
    echo -e "\n${YELLOW}Formatting Python SDK...${NC}"
    if make format-python; then
        echo -e "${GREEN}Python SDK: OK${NC}"
        git add python/
    else
        echo -e "${RED}Python SDK: FAILED${NC}"
        FAILED=true
    fi
fi

# Rust CLI
if [ "$RUST_CHANGED" = true ]; then
    echo -e "\n${YELLOW}Formatting Rust CLI...${NC}"
    if make format-rust; then
        echo -e "${GREEN}Rust CLI: OK${NC}"
        git add cli/
    else
        echo -e "${RED}Rust CLI: FAILED${NC}"
        FAILED=true
    fi
fi

# TypeScript SDK
if [ "$TYPESCRIPT_CHANGED" = true ]; then
    echo -e "\n${YELLOW}Formatting TypeScript SDK...${NC}"
    if make format-typescript; then
        echo -e "${GREEN}TypeScript SDK: OK${NC}"
        git add typescript/
    else
        echo -e "${RED}TypeScript SDK: FAILED${NC}"
        FAILED=true
    fi
fi

# Java SDK
if [ "$JAVA_CHANGED" = true ]; then
    echo -e "\n${YELLOW}Formatting Java SDK...${NC}"
    if make format-java; then
        echo -e "${GREEN}Java SDK: OK${NC}"
        git add java/
    else
        echo -e "${RED}Java SDK: FAILED${NC}"
        FAILED=true
    fi
fi

# n8n Node
if [ "$N8N_CHANGED" = true ]; then
    echo -e "\n${YELLOW}Formatting n8n node...${NC}"
    if make format-n8n; then
        echo -e "${GREEN}n8n node: OK${NC}"
        git add n8n-nodes-metadata/
    else
        echo -e "${RED}n8n node: FAILED${NC}"
        FAILED=true
    fi
fi

echo ""
if [ "$FAILED" = true ]; then
    echo -e "${RED}Pre-commit checks failed. Please fix the issues and try again.${NC}"
    exit 1
else
    echo -e "${GREEN}All pre-commit checks passed!${NC}"
    exit 0
fi
